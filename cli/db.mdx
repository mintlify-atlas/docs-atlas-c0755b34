---
title: "mofa db"
description: "Database initialization and schema management"
icon: "database"
---

The `mofa db` command provides database setup and migration tools for persistent storage backends.

## Subcommands

<CardGroup cols={2}>

<Card title="init" icon="play">
  Initialize database tables
</Card>

<Card title="schema" icon="code">
  Show database schema SQL
</Card>

</CardGroup>

## mofa db init

Initialize persistence database tables for agents, sessions, and memory.

### Usage

```bash
mofa db init -t <DB_TYPE> [OPTIONS]
```

### Options

#### `-t, --db-type <TYPE>`

**Required.** Database type to initialize.

- **Type:** Enum
- **Values:** `postgres`, `mysql`, `sqlite`

```bash
mofa db init -t postgres
```

#### `-o, --output <PATH>`

Output SQL to file instead of stdout.

- **Type:** Path
- **Default:** Stdout

When specified, SQL is written to file instead of printed.

```bash
mofa db init -t postgres -o migration.sql
```

#### `-u, --database-url <URL>`

Database connection URL. When provided, executes SQL directly.

- **Type:** String (connection URL)
- **Default:** None (output only mode)

<Note>
  Direct database execution requires the `db` feature. Build with `cargo install mofa-cli --features db`.
</Note>

```bash
mofa db init -t postgres \
  -u "postgresql://user:pass@localhost/mofa"
```

### Examples

#### Print SQL to stdout

```bash
mofa db init -t postgres
```

**Output:**

```sql
-- MoFA PostgreSQL Schema
-- Copy and execute this SQL to initialize your database

CREATE TABLE IF NOT EXISTS agents (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    state VARCHAR(50) NOT NULL,
    started_at TIMESTAMP NOT NULL,
    provider VARCHAR(100),
    model VARCHAR(100),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS sessions (
    session_id VARCHAR(255) PRIMARY KEY,
    agent_id VARCHAR(255),
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata JSONB,
    FOREIGN KEY (agent_id) REFERENCES agents(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS messages (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    FOREIGN KEY (session_id) REFERENCES sessions(session_id) ON DELETE CASCADE
);

CREATE INDEX idx_sessions_agent ON sessions(agent_id);
CREATE INDEX idx_messages_session ON messages(session_id);
CREATE INDEX idx_messages_timestamp ON messages(timestamp);
```

#### Save SQL to file

```bash
mofa db init -t postgres -o migration.sql
```

**Output:**

```
→ Generating postgres migration script...
✓ Migration script saved to: migration.sql
```

You can then execute the SQL manually:

```bash
psql -U user -d mofa -f migration.sql
```

#### Execute directly

```bash
mofa db init -t postgres \
  -u "postgresql://user:pass@localhost/mofa"
```

**Output:**

```
→ Initializing postgres database...
  URL: postgresql://user:****@localhost/mofa
  ✓ Created table: agents
  ✓ Created table: sessions
  ✓ Created table: messages
  ✓ Created indexes
✓ Database tables initialized successfully!
```

### Database Types

#### PostgreSQL

```bash
mofa db init -t postgres -u "postgresql://user:pass@localhost/mofa"
```

**Features:**
- JSONB support for metadata
- Full-text search capabilities
- Robust transaction support
- Recommended for production

#### MySQL

```bash
mofa db init -t mysql -u "mysql://user:pass@localhost/mofa"
```

**Features:**
- JSON column type
- Wide hosting support
- Good performance
- Compatible with MariaDB

#### SQLite

```bash
mofa db init -t sqlite -u "sqlite://./mofa.db"
```

**Features:**
- No server required
- File-based storage
- Great for development
- Single-user scenarios

---

## mofa db schema

Display the database schema SQL for a specific database type.

### Usage

```bash
mofa db schema -t <DB_TYPE>
```

### Options

#### `-t, --db-type <TYPE>`

**Required.** Database type to show schema for.

- **Type:** Enum
- **Values:** `postgres`, `mysql`, `sqlite`

```bash
mofa db schema -t postgres
```

### Examples

#### PostgreSQL Schema

```bash
mofa db schema -t postgres
```

**Output:**

```sql
-- MoFA POSTGRES Schema
-- Copy and execute this SQL to initialize your database

CREATE TABLE IF NOT EXISTS agents (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    state VARCHAR(50) NOT NULL,
    started_at TIMESTAMP NOT NULL,
    provider VARCHAR(100),
    model VARCHAR(100),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Additional tables and indexes...
```

#### MySQL Schema

```bash
mofa db schema -t mysql
```

**Output:**

```sql
-- MoFA MYSQL Schema
-- Copy and execute this SQL to initialize your database

CREATE TABLE IF NOT EXISTS agents (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    state VARCHAR(50) NOT NULL,
    started_at TIMESTAMP NOT NULL,
    provider VARCHAR(100),
    model VARCHAR(100),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Additional tables and indexes...
```

#### SQLite Schema

```bash
mofa db schema -t sqlite
```

**Output:**

```sql
-- MoFA SQLITE Schema
-- Copy and execute this SQL to initialize your database

CREATE TABLE IF NOT EXISTS agents (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    state TEXT NOT NULL,
    started_at TEXT NOT NULL,
    provider TEXT,
    model TEXT,
    description TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- Additional tables and indexes...
```

---

## Database Schema

### Tables

#### `agents`

Stores agent metadata and state.

| Column | Type | Description |
|--------|------|-------------|
| `id` | VARCHAR(255) | Agent unique identifier (PK) |
| `name` | VARCHAR(255) | Agent display name |
| `state` | VARCHAR(50) | Current state (Running, Stopped, etc.) |
| `started_at` | TIMESTAMP | Agent start time |
| `provider` | VARCHAR(100) | LLM provider (optional) |
| `model` | VARCHAR(100) | Model name (optional) |
| `description` | TEXT | Agent description (optional) |
| `created_at` | TIMESTAMP | Record creation time |
| `updated_at` | TIMESTAMP | Record last update time |

#### `sessions`

Stores conversation sessions.

| Column | Type | Description |
|--------|------|-------------|
| `session_id` | VARCHAR(255) | Session unique identifier (PK) |
| `agent_id` | VARCHAR(255) | Associated agent ID (FK) |
| `created_at` | TIMESTAMP | Session start time |
| `updated_at` | TIMESTAMP | Session last activity |
| `metadata` | JSONB/JSON/TEXT | Custom metadata |

#### `messages`

Stores conversation messages.

| Column | Type | Description |
|--------|------|-------------|
| `id` | SERIAL/INT | Message unique identifier (PK) |
| `session_id` | VARCHAR(255) | Associated session ID (FK) |
| `role` | VARCHAR(50) | Message role (user, assistant, system, tool) |
| `content` | TEXT | Message content |
| `timestamp` | TIMESTAMP | Message timestamp |

### Indexes

```sql
-- Session lookups by agent
CREATE INDEX idx_sessions_agent ON sessions(agent_id);

-- Message lookups by session
CREATE INDEX idx_messages_session ON messages(session_id);

-- Time-based message queries
CREATE INDEX idx_messages_timestamp ON messages(timestamp);
```

## Connection URLs

### PostgreSQL

```bash
# Basic format
postgresql://user:password@host:port/database

# Example
postgresql://mofa_user:secret@localhost:5432/mofa

# With SSL
postgresql://user:pass@host/db?sslmode=require

# Unix socket
postgresql:///dbname?host=/var/run/postgresql
```

### MySQL

```bash
# Basic format
mysql://user:password@host:port/database

# Example
mysql://mofa_user:secret@localhost:3306/mofa

# With SSL
mysql://user:pass@host/db?ssl-mode=REQUIRED

# Unix socket
mysql://user:pass@localhost/db?socket=/var/run/mysqld/mysqld.sock
```

### SQLite

```bash
# File path
sqlite://./mofa.db
sqlite:///absolute/path/to/mofa.db

# In-memory (testing only)
sqlite::memory:
```

## Common Workflows

### Initial Database Setup

<CodeGroup>

```bash PostgreSQL
# 1. Create database
creatdb mofa

# 2. Generate migration script
mofa db init -t postgres -o migration.sql

# 3. Review and execute
cat migration.sql
psql -d mofa -f migration.sql

# Or initialize directly
mofa db init -t postgres -u "postgresql://user:pass@localhost/mofa"
```

```bash MySQL
# 1. Create database
mysql -u root -p -e "CREATE DATABASE mofa;"

# 2. Generate migration script
mofa db init -t mysql -o migration.sql

# 3. Review and execute
cat migration.sql
mysql -u root -p mofa < migration.sql

# Or initialize directly
mofa db init -t mysql -u "mysql://user:pass@localhost/mofa"
```

```bash SQLite
# Initialize database file
mofa db init -t sqlite -u "sqlite://./mofa.db"

# File is created automatically
ls -lh mofa.db
```

</CodeGroup>

### Configure Agent for Database

Edit `agent.yml`:

```yaml
agent:
  id: my-agent
  name: My Agent

# Database configuration
persistence:
  enabled: true
  
  # PostgreSQL
  database:
    type: postgres
    url: ${DATABASE_URL}
  
  # Or SQLite
  # database:
  #   type: sqlite
  #   path: ~/.local/share/mofa/mofa.db

# Session persistence
session:
  persist: true
  ttl_seconds: 86400  # 24 hours
```

Set environment variable:

```bash
export DATABASE_URL="postgresql://user:pass@localhost/mofa"
```

### Verify Database Setup

```bash
# Connect to database
psql -d mofa

# List tables
\dt

# Check schema
\d agents
\d sessions
\d messages

# Test query
SELECT * FROM agents LIMIT 1;
```

### Backup Database

<CodeGroup>

```bash PostgreSQL
# Backup
pg_dump mofa > mofa_backup.sql

# Restore
psql mofa < mofa_backup.sql
```

```bash MySQL
# Backup
mysqldump mofa > mofa_backup.sql

# Restore
mysql mofa < mofa_backup.sql
```

```bash SQLite
# Backup
cp mofa.db mofa_backup.db

# Or export to SQL
sqlite3 mofa.db .dump > mofa_backup.sql
```

</CodeGroup>

## Feature Flag

<Warning>
  Direct database execution requires the `db` feature flag.
</Warning>

To enable database features:

```bash
# Install with database support
cargo install mofa-cli --features db

# Or build from source
cargo build --release --features db -p mofa-cli
```

Without the `db` feature, you can still:
- Generate SQL migration scripts
- Save scripts to files
- Execute scripts manually

## Security

### Connection String Security

<Warning>
  Never commit database URLs with credentials to version control.
</Warning>

**Best practices:**

1. **Use environment variables:**

```bash
export DATABASE_URL="postgresql://user:pass@localhost/mofa"
mofa db init -t postgres -u "$DATABASE_URL"
```

2. **Use `.env` files (not committed):**

```bash
# .env (add to .gitignore)
DATABASE_URL=postgresql://user:pass@localhost/mofa
```

3. **Use secrets management:**

```bash
# AWS Secrets Manager
DATABASE_URL=$(aws secretsmanager get-secret-value \
  --secret-id mofa/db --query SecretString --output text)
```

### Database User Permissions

Create a dedicated database user with minimal permissions:

```sql
-- PostgreSQL
CREATE USER mofa_app WITH PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE mofa TO mofa_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO mofa_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO mofa_app;

-- MySQL
CREATE USER 'mofa_app'@'localhost' IDENTIFIED BY 'secure_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON mofa.* TO 'mofa_app'@'localhost';
FLUSH PRIVILEGES;
```

## Troubleshooting

### Connection failed

```bash
mofa db init -t postgres -u "postgresql://localhost/mofa"
# Error: Failed to connect to PostgreSQL: ...
```

**Solutions:**
- Check database is running: `pg_isready`
- Verify connection details
- Check firewall/network settings
- Ensure database exists: `createdb mofa`

### Permission denied

```bash
mofa db init -t postgres -u "postgresql://user:pass@localhost/mofa"
# Error: SQL error: permission denied for table agents
```

**Solution:** Grant required permissions to user.

### Feature not available

```bash
mofa db init -t postgres -u "postgresql://localhost/mofa"
# Error: Direct database execution requires the 'db' feature
```

**Solution:** Install with database support:

```bash
cargo install mofa-cli --features db
```

## See Also

- [Configuration](/cli/config) - Configure database connection
- [Sessions](/cli/session) - Manage persisted sessions
- [Agent Management](/cli/agent) - Start agents with persistence